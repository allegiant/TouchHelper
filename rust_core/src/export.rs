use crate::constants::SIGNAL_BYTE;

use super::*;
use std::fs::{self, File};
use std::io::Write;
use std::path::Path;
use ts_rs::TS;

// ğŸ”¥ åœ¨è¿™é‡Œå®šä¹‰å¸¸é‡ï¼Œæƒ³æ€ä¹ˆæ”¹å°±æ€ä¹ˆæ”¹
const TS_OUTPUT_PATH: &str = "../script_template/src/types/touch-helper.d.ts";
// ğŸ”¥ æ–°å¢ï¼šAndroid Java å¸¸é‡è¾“å‡ºè·¯å¾„
// æ³¨æ„ï¼šè¿™ä¸ªè·¯å¾„æ˜¯ç›¸å¯¹äº rust_core ç›®å½•çš„
const JAVA_OUTPUT_PATH: &str =
    "../android/server/src/main/java/org/eu/freex/server/bind/GeneratedConstants.java";

#[test]
fn export_all() {
    export_ts_types();
    export_java_constants();
}

fn export_ts_types() {
    // 1. æ”¶é›†æ‰€æœ‰éœ€è¦å¯¼å‡ºçš„ç±»å‹å®šä¹‰
    // Struct::decl() ä¼šè¿”å›è¯¥ç»“æ„ä½“çš„ TypeScript å®šä¹‰å­—ç¬¦ä¸²
    let mut ts_content = String::from("// This file is auto-generated by Rust. Do not edit.\n\n");
    ts_content.push_str("export ");
    ts_content.push_str(&Action::decl());
    ts_content.push('\n');

    ts_content.push_str("export ");
    ts_content.push_str(&MacroConfig::decl());
    ts_content.push('\n');

    // å¦‚æœä½ æœ‰æ›´å¤šç»“æ„ä½“ï¼Œç»§ç»­ push...
    // ts_content.push_str(&AnotherStruct::decl());

    // 2. å†™å…¥æ–‡ä»¶
    let path = Path::new(TS_OUTPUT_PATH);

    // ç¡®ä¿çˆ¶ç›®å½•å­˜åœ¨
    if let Some(parent) = path.parent() {
        fs::create_dir_all(parent).unwrap();
    }

    fs::write(path, ts_content).expect("Failed to write TypeScript definitions");

    println!("âœ… TypeScript types exported to: {}", TS_OUTPUT_PATH);
}

// ğŸ”¥ æ–°å¢ï¼šç”Ÿæˆ Java å¸¸é‡æ–‡ä»¶
fn export_java_constants() {
    let path = Path::new(JAVA_OUTPUT_PATH);

    // è‡ªåŠ¨åˆ›å»ºç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    if let Some(parent) = path.parent() {
        fs::create_dir_all(parent).unwrap();
    }

    let mut file = File::create(path).expect("Failed to create Java constants file");

    // æ‹¼æ¥ Java ä»£ç 
    // æ³¨æ„ï¼špackage åè¦å’Œä½ çš„ Java ç›®å½•å¯¹åº”
    let java_content = format!(
        r#"package org.eu.freex.server;

/**
 * Auto-generated by Rust (rust_core/src/export.rs).
 * DO NOT EDIT THIS FILE MANUALLY.
 * ä¿®æ”¹æºå¤´: rust_core/src/constants.rs
 */
public class GeneratedConstants {{
    public static final String SHARED_FILE_PATH = "{shared_path}";
    // ä½¿ç”¨åå…­è¿›åˆ¶æ ¼å¼åŒ–ï¼Œå¹¶åœ¨ Java ä¸­ä¿ç•™æ³¨é‡Šè¯´æ˜å¤§å°
    public static final byte SIGNAL_BYTE = (byte) {signal_byte};
    public static final int SHARED_MEMORY_SIZE = {mem_size}; // {mem_size_desc}
}}
"#,
        shared_path = SHARED_FILE_PATH,
        // ğŸ”¥ ä¿®æ”¹ç‚¹ 1: ä½¿ç”¨ 0x{:02X} å¼ºåˆ¶è¾“å‡ºåå…­è¿›åˆ¶ (ä¾‹å¦‚ 0xAA)
        signal_byte = format!("0x{:02X}", SIGNAL_BYTE),
        // ğŸ”¥ ä¿®æ”¹ç‚¹ 2: ä¿æŒæ•°å­—ï¼Œä½†åœ¨åé¢åŠ ä¸ªæ³¨é‡Šæ˜¾ç¤ºè®¡ç®—é€»è¾‘ï¼Œæˆ–è€…ç›´æ¥è¾“å‡ºåŸå€¼
        mem_size = SHARED_MEMORY_SIZE,
        // (å¯é€‰) å¦‚æœæƒ³æ›´ç›´è§‚ï¼Œå¯ä»¥åŠ ä¸ªæè¿°å­—ç¬¦ä¸²å‚æ•°
        mem_size_desc = format!("{} MB", SHARED_MEMORY_SIZE / (1024 * 1024)),
    );

    file.write_all(java_content.as_bytes()).unwrap();
    println!("âœ… Java constants generated at: {}", JAVA_OUTPUT_PATH);
}
